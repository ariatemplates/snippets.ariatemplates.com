/**
 * Copyright 2012 Amadeus s.a.s.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(){var e=null,h=null,g=null,i=null;Aria.classDefinition({$classpath:"aria.tools.contextual.ContextualMenu",$singleton:true,$dependencies:["aria.utils.Event","aria.DomEvent","aria.templates.TemplateCtxtManager","aria.popups.Popup","aria.widgets.Template","aria.utils.Dom","aria.tools.contextual.environment.ContextualMenu","aria.utils.AriaWindow"],$implements:["aria.tools.contextual.IContextualMenu"],$constructor:function(){e=aria.utils.Event;h=aria.templates.TemplateCtxtManager;g=aria.tools.contextual.environment.ContextualMenu;
i=aria.utils.Dom;this._enabled=false;this._appEnvCfg=this.targetTemplateCtxt=this._popup=null;g.$on({environmentChanged:this._environmentChanged,scope:this});this._environmentChanged();aria.utils.AriaWindow.$on({attachWindow:this._attachWindow,detachWindow:this._detachWindow,scope:this})},$destructor:function(){aria.core.environment.Environment.$unregisterListeners(this);aria.utils.AriaWindow.$unregisterListeners(this);this._setEnabled(false);this._popup&&this._popup.close();this.targetTemplateCtxt=
null},$prototype:{_attachWindow:function(){this._setEnabled(g.getContextualMenu().enabled)},_detachWindow:function(){this._setEnabled(false)},_environmentChanged:function(){var a=g.getContextualMenu();this._appEnvCfg=a;this._setEnabled(a.enabled)},_setEnabled:function(a){var b=Aria.$window.document;if(a){if(aria.widgets.AriaSkin){this._enabled=true;e.addListener(b,"contextmenu",{fn:this._onContextMenu,scope:this});aria.core.Browser.isSafari&&e.addListener(b,"mouseup",{fn:this._onSafariMouseUp,scope:this})}}else{this._enabled=
false;e.removeListener(b,"contextmenu",{fn:this._onContextMenu});aria.core.Browser.isSafari&&e.removeListener(b,"mouseup",{fn:this._onSafariMouseUp})}},_onSafariMouseUp:function(a){this._safariCtrlKey=a.ctrlKey},_onContextMenu:function(a){if(this._enabled){a=new aria.DomEvent(a);if(aria.core.Browser.isSafari)a.ctrlKey=this._safariCtrlKey;if(a.ctrlKey){a.stopPropagation();a.preventDefault();this.__callContextualMenu(a.target,a.clientX,a.clientY);a.$dispose();return false}a.$dispose()}},open:function(a,
b){this._popup&&aria.tools.contextual.ContextualMenu.close();var c={};c=b?b:a.$TemplateCtxt?{x:0,y:0}:i.getGeometry(a);if(a.$TemplateCtxt)this._notifyFound(a,c.x,c.y);else{this.__callContextualMenu(a,c.x,c.y);return false}},__callContextualMenu:function(a,b,c){for(var d,f=Aria.$window.document.body;a&&a!=f&&!a.__template;){d=a;a=a.parentNode}if(a==f&&d){if(aria.popups&&aria.popups.PopupManager)(a=aria.popups.PopupManager.getPopupFromDom(d))&&a.section&&a.section.tplCtxt&&this._notifyFound(a.section.tplCtxt,
b,c)}else a&&a!=f&&this._notifyFound(h.getFromDom(a.parentNode),b,c)},_afterClose:function(){if(this._popup){this._popup.$dispose();this._popup=null}},_notifyFound:function(a,b,c){var d=aria.tools.ToolsBridge;d&&d.isOpen&&d.$raiseEvent({name:"forwardEvent",event:{name:"ContextualTargetFound",templateCtxt:a}});if(!this._popup){this._popup=d=new aria.popups.Popup;d.$on({onAfterClose:this._afterClose,scope:this});var f=a.createSection({fn:function(j){var k=new aria.widgets.Template({defaultTemplate:this._appEnvCfg.template,
moduleCtrl:{classpath:this._appEnvCfg.moduleCtrl,initArgs:{templateCtxt:a.$interface("aria.templates.ITemplateCtxt"),driver:this.$interface("aria.tools.contextual.IContextualMenu")}}},a,"NOLINE");j.registerBehavior(k);k.writeMarkup(j)},scope:this});d.open({section:f,absolutePosition:{top:c,left:b},modal:true,preferredPositions:[{reference:"bottom left",popup:"top left"},{reference:"bottom left",popup:"top right"}],offset:{top:0,left:0},closeOnMouseClick:true,closeOnMouseScroll:true});this.targetTemplateCtxt=
a}},close:function(){this.targetTemplateCtxt=null;this._popup&&this._popup.close()},openTools:function(){if(!aria.tools.ToolsBridge||!aria.tools.ToolsBridge.isOpen)Aria.load({classes:["aria.tools.ToolsBridge"],oncomplete:function(){aria.tools.ToolsBridge.open();aria.tools.contextual.ContextualMenu.close()}})}}})})();