/**
 * Copyright 2012 Amadeus s.a.s.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
Aria.classDefinition({$classpath:"aria.tools.inspector.InspectorModule",$extends:"aria.templates.ModuleCtrl",$dependencies:["aria.utils.Event","aria.utils.Dom","aria.utils.Json"],$templates:["aria.tools.inspector.InspectorDisplay"],$implements:["aria.tools.inspector.IInspectorModule"],$constructor:function(){this.$ModuleCtrl.constructor.call(this);this.bridge=null;this._data={templates:[],modules:[],dataFragments:[],selectedTemplate:null,selectedModule:null,locked:false};this._replaceHtmlOriginal=
this._mainContextual=this._hideTimeout=this._holder=null},$destructor:function(){this.clearHightlight();var a=this.bridge.getAriaPackage().utils.Dom;a.replaceHTML=this._replaceHtmlOriginal;this._replaceHtmlOriginal=null;a.insertAdjacentHTML=this._insertAdjacentHtmlOriginal;this._insertAdjacentHtmlOriginal=null;a.removeElement=this._removeElementOriginal;this._removeElementOriginal=null;this.$ModuleCtrl.$destructor.call(this)},$prototype:{$publicInterfaceName:"aria.tools.inspector.IInspectorModule",
init:function(a){this.bridge=a.bridge;this.$assert(77,!!this.bridge);var b=this.bridge.getAriaPackage().utils.Dom;this._replaceHtmlOriginal=b.replaceHTML;b.replaceHTML=this._interceptMethod(this._replaceHtmlOriginal);this._insertAdjacentHtmlOriginal=b.insertAdjacentHTML;b.insertAdjacentHTML=this._interceptMethod(this._insertAdjacentHtmlOriginal);this._removeElementOriginal=b.removeElement;b.removeElement=this._interceptMethod(this._removeElementOriginal);this.bridge.$on({forwardEvent:this._onForward,
scope:this});b=this.bridge.getDocument();this._holder=b.createElement("div");b.body.appendChild(this._holder);this.refreshInformations();(this._mainContextual=Aria.nspace("tools.contextual.ContextualMenu",false,this.bridge.getAriaPackage()))&&this._mainContextual.targetTemplateCtxt&&this._selectFromTemplateCtxt(this._mainContextual.targetTemplateCtxt);this.$ModuleCtrl.init.apply(this,arguments)},_interceptMethod:function(a){var b=this,e=function(){try{b.refreshInformations()}catch(d){}};return function(d,
c,f){d=a.call(this,d,c,f);setTimeout(e);return d}},refreshInformations:function(){this._data.templates=[];this._data.modules=[];this._data.dataFragments=[];var a=this._data.templates,b=this._data.modules,e=this._data.dataFragments,d=this._data.selectedTemplate,c=this._data.selectedModule,f=this.bridge.getAriaPackage().templates.RefreshManager;if(f!=null){f.updateHierarchies();this._convertRefreshMgrHierarchies(f.getHierarchies(),a,b,e)}if(d==this._data.selectedTemplate)this._data.selectedTemplate=
null;if(c==this._data.selectedModule)this._data.selectedModule=null;this.$raiseEvent("contentChanged")},_convertRefreshMgrHierarchies:function(a,b,e,d,c){for(var f=0,h=a.length;f<h;f++)this._convertRefreshMgrHierarchy(a[f],b,e,d,c)},_convertRefreshMgrHierarchy:function(a,b,e,d,c){if(a.type=="template"||a.type=="templateWidget"){c=a.elem;if(a.type=="templateWidget")c=c.behavior?c.behavior.subTplCtxt:c.subTplCtxt;var f=this._data.selectedTemplate,h=this._data.selectedModule,g=[],m=[],k=false,i,n=this.bridge.getAriaPackage().templates.ModuleCtrlFactory;
this.$assert(190,!!c);this.$assert(191,!!n);var j=c.moduleCtrl;if(j){for(var l=0,o=e.length;l<o;l++){i=e[l];if(i.moduleCtrl==j){if(!i.current){i.outerTemplateCtxts.push(c);i.current=true}k=true}else i.current=false}if(!k){k={moduleCtrl:j,outerTemplateCtxts:[c],current:true,isReloadable:n.isModuleCtrlReloadable(j)};if(h&&h.moduleCtrl==j)this._data.selectedModule=k;e.push(k)}}h={templateCtxt:c,content:g,moduleCtrl:j,widgets:m};if(f&&f.templateCtxt==c)this._data.selectedTemplate=h;b.push(h);c=m;b=g}else if(a.type==
"widget"){g=a.elem.behavior;if(c&&g){g={widget:g};c.push(g);if(a.content){c=[];g.content=c}}}a.content&&this._convertRefreshMgrHierarchies(a.content,b,e,d,c)},clearHightlight:function(){if(this._hideTimeout){clearInterval(this._hideTimeout);this._hideTimeout=null}this._holder.innerHTML=""},displayHighlight:function(a,b){this.clearHightlight();b=b?b:"#ACC2FF";var e=this.bridge.getAriaPackage().utils.Dom.calculatePosition(a),d=this.bridge.getDocument().createElement("div");d.style.cssText=["position:absolute;top:",
e.top,"px;left:",e.left,"px;width:",a.offsetWidth-8>0?a.offsetWidth-8:0,"px;height:",a.offsetHeight-8>0?a.offsetHeight-8:0,"px; border:dashed 4px "+b+";z-index: 999999999999999;z-index: 999999999999999;"].join("");this._holder.appendChild(d);this._hideTimeout=setTimeout(aria.utils.Function.bind(this.clearHightlight,this),2E3)},reloadTemplate:function(a,b){aria.utils.Json.setValue(this._data,"locked",true);if(b)b=this._data.selectedTemplate.tplSrcEdit;this.clearHightlight();this._mainContextual&&a.tplClasspath!=
this._mainContextual.CONTEXTUAL_TEMPLATE_CLASSPATH&&this._mainContextual.close();this.bridge.getAria();this.bridge.getAriaPackage();a.$reload(b,{fn:this._unlock,scope:this})},_unlock:function(){var a=this._data;setTimeout(function(){aria.utils.Json.setValue(a,"locked",false)},500)},reloadModule:function(a){var b=this.bridge.getAriaPackage().templates.ModuleCtrlFactory;aria.utils.Json.setValue(this._data,"locked",true);this.clearHightlight();b.reloadModuleCtrl(a,{fn:this._unlock,scope:this})},refreshTemplate:function(a){this.clearHightlight();
a.$refresh()},_onForward:function(a){a.event.name=="ContextualTargetFound"&&this._selectFromTemplateCtxt(a.event.templateCtxt)},_selectFromTemplateCtxt:function(a){var b=a.moduleCtrlPrivate,e=this._data.modules,d,c;d=0;for(c=e.length;d<c;d++)if(e[d].moduleCtrl==b){this._data.selectedModule=e[d];break}else this._data.selectedModule=null;this._data.selectedTemplate=this._findTemplateDes(this._data.templates,a)},_findTemplateDes:function(a,b){var e=null,d,c;d=0;for(c=a.length;d<c;d++){e=a[d];if(e.templateCtxt==
b)return e;else if(e=this._findTemplateDes(e.content,b))return e}return null},getSource:function(a){return this.bridge.getAriaPackage().core.Cache.getItem("files",a,false)}}});